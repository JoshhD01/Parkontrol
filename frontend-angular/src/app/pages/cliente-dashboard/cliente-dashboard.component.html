<div class="contenedor-cliente">
  <section class="cabecera">
    <div>
      <h1>Panel del Cliente</h1>
      <p>Bienvenido, {{ correoCliente }}</p>
    </div>
    <div class="cabecera-acciones">
      <button mat-stroked-button color="accent" (click)="toggleCambioContrasena()">
        <mat-icon>lock</mat-icon>
        Cambiar Contraseña
      </button>
      <button mat-stroked-button color="primary" (click)="cerrarSesion()">
        Cerrar sesión
      </button>
    </div>
  </section>

  @if (mostrarCambioContrasena) {
    <mat-card class="cambio-contrasena-card">
      <mat-card-title>Cambiar mi contraseña</mat-card-title>
      <div class="cambio-contrasena-form">
        <mat-form-field appearance="outline" class="campo">
          <mat-label>Contraseña actual</mat-label>
          <input matInput [type]="hideContrasenaActual ? 'password' : 'text'" [(ngModel)]="contrasenaActual" name="contrasenaActual">
          <button mat-icon-button matSuffix type="button" (click)="hideContrasenaActual = !hideContrasenaActual">
            <mat-icon>{{ hideContrasenaActual ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline" class="campo">
          <mat-label>Nueva contraseña</mat-label>
          <input matInput [type]="hideNuevaContrasena ? 'password' : 'text'" [(ngModel)]="nuevaContrasena" name="nuevaContrasena">
          <button mat-icon-button matSuffix type="button" (click)="hideNuevaContrasena = !hideNuevaContrasena">
            <mat-icon>{{ hideNuevaContrasena ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </mat-form-field>
        @if (errorContrasena) {
          <p class="error-text">{{ errorContrasena }}</p>
        }
        @if (mensajeContrasena) {
          <p class="exito-text">{{ mensajeContrasena }}</p>
        }
        <div class="cambio-contrasena-actions">
          <button mat-raised-button color="primary" (click)="cambiarContrasena()">Guardar</button>
          <button mat-stroked-button (click)="toggleCambioContrasena()">Cancelar</button>
        </div>
      </div>
    </mat-card>
  }

  @if (errorMessage) {
    <mat-card class="alerta-error">
      <mat-icon>error</mat-icon>
      <span>{{ errorMessage }}</span>
    </mat-card>
  }

  <section class="metricas">
    <mat-card class="kpi">
      <mat-icon>directions_car</mat-icon>
      <div>
        <h3>{{ totalVehiculos }}</h3>
        <p>Vehículos registrados</p>
      </div>
    </mat-card>

    <mat-card class="kpi">
      <mat-icon>event_available</mat-icon>
      <div>
        <h3>{{ totalReservas }}</h3>
        <p>Reservas registradas</p>
      </div>
    </mat-card>

    <mat-card class="kpi">
      <mat-icon>receipt_long</mat-icon>
      <div>
        <h3>{{ totalFacturas }}</h3>
        <p>Facturas emitidas</p>
      </div>
    </mat-card>

    <mat-card class="kpi">
      <mat-icon>payments</mat-icon>
      <div>
        <h3>{{ totalPagos }}</h3>
        <p>Pagos realizados</p>
      </div>
    </mat-card>
  </section>

  <section class="grid-principal">
    <mat-card class="panel panel-accion">
      <mat-card-title>Reservar estacionamiento</mat-card-title>
      <mat-card-subtitle>Asignación automática de celda por disponibilidad</mat-card-subtitle>

      <mat-form-field appearance="outline" class="campo">
        <mat-label>Parqueadero</mat-label>
        <select matNativeControl [(ngModel)]="nuevaReserva.idParqueadero" name="idParqueadero">
          <option [value]="0">Selecciona un parqueadero</option>
          @for (parqueadero of parqueaderos; track parqueadero.id) {
            <option [value]="parqueadero.id">
              #{{ parqueadero.id }} - {{ parqueadero.nombre }} ({{ parqueadero.celdasDisponibles ?? '?' }} celdas disponibles)
            </option>
          }
        </select>
      </mat-form-field>

      <div class="modo-vehiculo">
        <label>
          <input type="radio" name="modoVehiculo" [checked]="usarVehiculoExistente" (change)="usarVehiculoExistente = true">
          Vehículo registrado
        </label>
        <label>
          <input type="radio" name="modoVehiculo" [checked]="!usarVehiculoExistente" (change)="usarVehiculoExistente = false">
          Vehículo nuevo
        </label>
      </div>

      @if (usarVehiculoExistente) {
        <mat-form-field appearance="outline" class="campo">
          <mat-label>Mis vehículos</mat-label>
          <select matNativeControl [(ngModel)]="idVehiculoSeleccionado" name="idVehiculoSeleccionado">
            <option [value]="0">Selecciona un vehículo</option>
            @for (vehiculo of vehiculosCliente; track vehiculo.id) {
              <option [value]="vehiculo.id">
                {{ vehiculo.placa }} - {{ formatearTipoVehiculo(vehiculo) }}
              </option>
            }
          </select>
        </mat-form-field>
      } @else {
        <mat-form-field appearance="outline" class="campo">
          <mat-label>Placa</mat-label>
          <input matInput [(ngModel)]="nuevaReserva.placa" name="placa" placeholder="ABC123">
        </mat-form-field>

        <mat-form-field appearance="outline" class="campo">
          <mat-label>Tipo de vehículo</mat-label>
          <select matNativeControl [(ngModel)]="nuevaReserva.idTipoVehiculo" name="idTipoVehiculo">
            <option [value]="1">Particular</option>
            <option [value]="2">Moto</option>
          </select>
        </mat-form-field>
      }

      <mat-form-field appearance="outline" class="campo">
        <mat-label>Hora inicio</mat-label>
        <input matInput type="datetime-local" [(ngModel)]="nuevaReserva.horaInicio" name="horaInicio">
      </mat-form-field>

      <mat-form-field appearance="outline" class="campo">
        <mat-label>Hora fin</mat-label>
        <input matInput type="datetime-local" [(ngModel)]="nuevaReserva.horaFin" name="horaFin">
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="crearReserva()" [disabled]="loading">
        Confirmar reserva
      </button>
    </mat-card>

    <mat-card class="panel">
      <mat-card-title>Mis reservas</mat-card-title>
      @if (!reservas.length) {
        <p class="vacio">Aún no tienes reservas.</p>
      }
      @for (reserva of reservas; track reserva.id) {
        <div class="item-linea">
          <span>Reserva #{{ reserva.id }}</span>
          <small>{{ obtenerEstadoReserva(reserva.estado) }}</small>
        </div>
      }
    </mat-card>

    <mat-card class="panel">
      <mat-card-title>Mis facturas</mat-card-title>
      @if (!facturas.length) {
        <p class="vacio">Aún no tienes facturas.</p>
      }
      @for (factura of facturas; track factura.id) {
        <div class="item-linea">
          <span>Factura #{{ factura.id }}</span>
          <small>{{ factura.cufe }}</small>
        </div>
      }
    </mat-card>

    <mat-card class="panel">
      <mat-card-title>Mis pagos</mat-card-title>
      @if (!misPagos.length) {
        <p class="vacio">Aún no tienes pagos registrados.</p>
      }
      @for (pago of misPagos; track pago.id) {
        <div class="item-linea">
          <span>Pago #{{ pago.id }} - ${{ pago.monto }}</span>
          <small>{{ pago.metodoPago?.nombre || 'N/A' }} | {{ pago.reserva?.vehiculo?.placa || '' }}</small>
        </div>
      }
    </mat-card>
  </section>
</div>
